<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sum by Duplicate Number</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; font-size: 16px; }
    .card { max-width: 900px; margin: 0 auto; padding: 16px; border: 1px solid #ddd; border-radius: 12px; }
    h1 { font-size: 28px; margin: 0 0 12px; }
    .row { display: grid; grid-template-columns: 200px 200px 200px; gap: 40px; }
    label { font-size: 16px; color: #444; display: block; margin-bottom: 4px; font-weight: bold; }
    input, textarea, button { width: 100%; font-size: 18px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    .row input { padding: 8px; margin-bottom: 0; }
    button { cursor: pointer; border: 0; }
    .btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; margin-bottom: 34px; }
    .quick-add-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: -8px; margin-bottom: 24px; grid-column: 1 / -1; }
    .quick-add-btns button { padding: 8px; font-size: 14px; font-weight: 600; background: linear-gradient(to bottom, #ffffff, #f3f4f6); border: 2px solid #9ca3af; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.15s ease; }
    .quick-add-btns button:hover { background: linear-gradient(to bottom, #f9fafb, #e5e7eb); border-color: #6b7280; box-shadow: 0 2px 4px rgba(0,0,0,0.15); transform: translateY(-1px); }
    .quick-add-btns button:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .primary { background: #111827; color: white; }
    .secondary { background: #e5e7eb; }
    .danger { background: #fee2e2; }
    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; font-size: 16px; }
    th { font-size: 16px; color: #555; font-weight: 600; }
    .muted { color: #6b7280; font-size: 15px; margin-top: 8px; }
    .total { font-weight: 700; }
    .twoCol { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .raw-item { padding: 4px 0; }
    .raw-item-latest { font-size: 17px; font-weight: 600; }
    .draw-row { margin-bottom: 10px; }
    .delete-btn { background: #ef4444; color: white; border: 1px solid black; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 12px; width: 100px; display: inline-block; vertical-align: middle; text-align: center; }
    .delete-btn:hover { background: #dc2626; }
    .heatmap-container { margin-top: 24px; }
    .heatmap-title { font-size: 20px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; flex-wrap: nowrap; }
    .heatmap-title span { white-space: nowrap; }
    .heatmap-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; max-width: 600px; max-height: 900px; }
    .heatmap-grid-large { max-width: 750px; gap: 5px; }
    .heatmap-grid-large .heatmap-cell-number { font-size: 16px; }
    .heatmap-grid-large .heatmap-cell-value { font-size: 11px; }
    .heatmap-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid #e5e7eb; position: relative; transition: transform 0.1s; }
    .heatmap-cell-number { font-size: 14px; font-weight: 600; }
    .heatmap-cell-value { font-size: 10px; font-weight: 400; margin-top: 2px; }
    .heatmap-cell-label { font-style: italic; }
    .heatmap-cell:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .heatmap-legend { display: flex; align-items: center; gap: 8px; margin-top: 12px; font-size: 14px; }
    .heatmap-legend-item { display: flex; align-items: center; gap: 4px; }
    .heatmap-legend-box { width: 20px; height: 20px; border-radius: 3px; border: 1px solid #ccc; }
    .show-all-btn { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-top: 8px; display: inline-block; border: 0; }
    .show-all-btn:hover { background: #2563eb; }
    .pair-mode-btn { background: #8b5cf6; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-block; border: 0; margin-left: 18px; width: 120px; text-align: center; }
    .pair-mode-btn:hover { background: #7c3aed; }
    .pair-mode-btn.active { background: #6d28d9; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
    .heatmap-cell.highlight-pair { box-shadow: 0 0 0 3px #fbbf24, 0 0 12px rgba(251, 191, 36, 0.5); z-index: 20; transform: scale(1.05); }
    .heatmap-cell.highlight-double { box-shadow: 0 0 0 3px #8b5cf6, 0 0 12px rgba(139, 92, 246, 0.5); z-index: 20; transform: scale(1.05); }
    @media (max-width: 720px) {
      .row, .btns, .twoCol { grid-template-columns: 1fr; }
      .heatmap-grid { grid-template-columns: repeat(10, 1fr); gap: 2px; max-height: 200px; }
      .heatmap-cell-number { font-size: 10px; }
      .heatmap-cell-value { font-size: 7px; margin-top: 1px; }
      .heatmap-cell.highlight-pair { box-shadow: 0 0 0 2px #fbbf24, 0 0 8px rgba(251, 191, 36, 0.5); z-index: 20; transform: scale(1.05); }
      .heatmap-cell.highlight-double { box-shadow: 0 0 0 2px #8b5cf6, 0 0 8px rgba(139, 92, 246, 0.5); z-index: 20; transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ตารางคำนวณ หวย!!!</h1>

    <div class="row draw-row">
      <div>
        <label>งวดที่</label>
        <input id="drawNumberInput" inputmode="numeric" placeholder="1 หรือ 2" maxlength="1" />
      </div>
      <div>
        <label>เดือน</label>
        <select id="monthSelect">
          <option value="">เลือกเดือน</option>
        </select>
      </div>
      <div>
        <label>ปี (พ.ศ.)</label>
        <input id="yearInput" inputmode="numeric" placeholder="เช่น 2568" maxlength="4" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>เลขที่ซื้อ</label>
        <input id="keyInput" inputmode="numeric" placeholder="เช่น 12" maxlength="2" />
      </div>
      <div>
        <label>บน</label>
        <input id="topInput" inputmode="decimal" placeholder="เช่น 100" />
      </div>
      <div>
        <label>ล่าง</label>
        <input id="bottomInput" inputmode="decimal" placeholder="เช่น 100" />
      </div>
      <div class="quick-add-btns">
        <button type="button" onclick="addToBothInputs(5)">+5</button>
        <button type="button" onclick="addToBothInputs(10)">+10</button>
        <button type="button" onclick="addToBothInputs(20)">+20</button>
        <button type="button" onclick="addToBothInputs(30)">+30</button>
        <button type="button" onclick="addToBothInputs(50)">+50</button>
        <button type="button" onclick="addToBothInputs(100)">+100</button>
        <button type="button" onclick="addToBothInputs(150)">+150</button>
        <button type="button" onclick="addToBothInputs(200)">+200</button>
      </div>
    </div>

    <div class="btns">
      <button class="primary" id="addBtn">เพิ่มรายการ</button>
      <button class="secondary" id="exportBtn">คัดลอกสรุป</button>
      <button class="danger" id="clearBtn">ล้างทั้งหมด</button>
    </div>

    <div>
      <label>รายการดิบ</label>
      <div id="rawList" class="muted">ยังไม่มีรายการ</div>
    </div>

    <div class="heatmap-container">
      <div class="heatmap-title"><span>Heat Map: ยอดรวมเงินรางวัลทั้งหมด (บน + ล่าง)</span><button class="pair-mode-btn" id="pairModeBtnPrize" onclick="togglePairMode('prize')">เรียงแบบคู่</button></div>
      <div id="heatmapGridPrize" class="heatmap-grid heatmap-grid-large"></div>
      <div class="heatmap-legend">
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #f3f4f6; border: 3px solid #d1d5db;"></div>
          <span>0</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #f3f4f6; border: 3px solid #9ca3af;"></div>
          <span>>0-5K</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #fecaca; border: 3px solid #fca5a5;"></div>
          <span>>5K-10K</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #fca5a5; border: 3px solid #f87171;"></div>
          <span>>10K-20K</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #f87171; border: 3px solid #ef4444; color: #ffffff;"></div>
          <span>>20K-40K</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #ef4444; border: 3px solid #dc2626; color: #ffffff;"></div>
          <span>>40K-100K</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #b91c1c; border: 3px solid #991b1b; color: #ffffff;"></div>
          <span>>100K</span>
        </div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ตัวเลข</th>
          <th>จำนวนรายการ</th>
          <th>ยอดรวม (บน)</th>
          <th>ยอดรวม (ล่าง)</th>
          <th>ยอดรวมทั้งหมด</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
      <tfoot>
        <tr>
          <td class="total">รวมทั้งหมด</td>
          <td class="total" id="totalCount">0</td>
          <td class="total" id="grandPrizeTop">0</td>
          <td class="total" id="grandPrizeBottom">0</td>
          <td class="total" id="grandTotal">0</td>
        </tr>
      </tfoot>
    </table>

    <div class="muted">Tip: ใส่เลขซ้ำได้ ระบบจะรวมยอดให้อัตโนมัติ</div>

    <div class="heatmap-container">
      <div class="heatmap-title"><span>Heat Map: ยอดรวมทั้งหมด (บน + ล่าง)</span><button class="pair-mode-btn" id="pairModeBtn" onclick="togglePairMode('total')">เรียงแบบคู่</button></div>
      <div id="heatmapGrid" class="heatmap-grid heatmap-grid-large"></div>
      <div class="heatmap-legend">
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #f3f4f6;"></div>
          <span>0</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #d1fae5;"></div>
          <span>น้อย</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #6ee7b7;"></div>
          <span>ปานกลาง</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #34d399;"></div>
          <span>ปานกลาง-มาก</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #10b981;"></div>
          <span>มาก</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-box" style="background: #059669;"></div>
          <span>มากที่สุด</span>
        </div>
      </div>
    </div>

  </div>

<script>
  // เก็บรายการดิบ: [{draw: "มกราคม งวด 1", key: "123", top: 100, bottom: 50}, ...]
  const STORAGE_KEY = 'lottery_items';
  const items = loadFromStorage();
  let showAllItems = false;
  let showAllTableRows = false;
  let pairModeActive = { prize: false, total: false };

  const drawNumberInput = document.getElementById('drawNumberInput');
  const monthSelect = document.getElementById('monthSelect');
  const yearInput = document.getElementById('yearInput');
  const keyInput = document.getElementById('keyInput');
  const topInput = document.getElementById('topInput');
  const bottomInput = document.getElementById('bottomInput');
  const addBtn = document.getElementById('addBtn');
  const clearBtn = document.getElementById('clearBtn');
  const summaryBody = document.getElementById('summaryBody');
  const totalCountEl = document.getElementById('totalCount');
  const grandPrizeTopEl = document.getElementById('grandPrizeTop');
  const grandPrizeBottomEl = document.getElementById('grandPrizeBottom');
  const grandTotalEl = document.getElementById('grandTotal');
  const rawList = document.getElementById('rawList');
  const exportBtn = document.getElementById('exportBtn');

  const LAST_DRAW_KEY = 'last_draw_selection';

  // สร้างตัวเลือกเดือน
  function initMonthOptions() {
    const months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                    'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];

    monthSelect.innerHTML = '<option value="">เลือกเดือน</option>';
    months.forEach(month => {
      monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
    });

    // ตั้งค่าปีเริ่มต้น
    const currentYear = new Date().getFullYear() + 543; // ปี พ.ศ.
    yearInput.value = currentYear;
  }

  // โหลดงวดล่าสุดที่เลือก
  function loadLastDraw() {
    try {
      const saved = localStorage.getItem(LAST_DRAW_KEY);
      if (saved) {
        const { drawNumber, month, year } = JSON.parse(saved);
        drawNumberInput.value = drawNumber;
        monthSelect.value = month;
        if (year) yearInput.value = year;
      }
    } catch {
      // ignore
    }
  }

  // เซฟงวดที่เลือก
  function saveLastDraw(drawNumber, month, year) {
    try {
      localStorage.setItem(LAST_DRAW_KEY, JSON.stringify({ drawNumber, month, year }));
    } catch {
      // ignore
    }
  }

  function loadFromStorage() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch {
      return [];
    }
  }

  function saveToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    } catch (e) {
      console.error('Failed to save data:', e);
    }
  }

  function parseAmount(v) {
    // อนุญาต 1,200.50 -> 1200.50
    const cleaned = String(v).replace(/,/g, '').trim();
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : null;
  }

  function addItem(drawNumber, month, year, key, top, bottom) {
    const dn = String(drawNumber).trim();
    if (!dn) return alert('กรุณาใส่งวดที่ (1 หรือ 2)');
    if (dn !== '1' && dn !== '2') return alert('งวดที่ต้องเป็น 1 หรือ 2 เท่านั้น');
    const m = String(month).trim();
    if (!m) return alert('กรุณาเลือกเดือน');
    const y = String(year).trim();
    if (!y) return alert('กรุณาใส่ปี');
    if (!/^\d{4}$/.test(y)) return alert('กรุณาใส่ปี พ.ศ. 4 หลัก (เช่น 2568)');
    const draw = `${m} ${y} งวด ${dn}`;

    const k = String(key).trim();
    if (!k) return alert('กรุณาใส่ตัวเลข (Key)');
    if (!/^\d{2}$/.test(k)) return alert('กรุณาใส่เลข 2 หลักเท่านั้น (00-99)');
    const t = parseAmount(top) || 0;
    const b = parseAmount(bottom) || 0;
    if (t === 0 && b === 0) return alert('กรุณาใส่จำนวนเงิน บน หรือ ล่าง');

    items.push({ draw: draw, key: k, top: t, bottom: b });
    saveLastDraw(dn, m, y);
    saveToStorage();
    render();
  }

  function summarize() {
    // map: key -> {count, topSum, bottomSum, totalSum}
    const map = new Map();
    let grandTotal = 0;
    let grandTopSum = 0;
    let grandBottomSum = 0;

    for (const it of items) {
      const itemTotal = it.top + it.bottom;
      grandTotal += itemTotal;
      grandTopSum += it.top;
      grandBottomSum += it.bottom;
      if (!map.has(it.key)) map.set(it.key, { count: 0, topSum: 0, bottomSum: 0, totalSum: 0 });
      const cur = map.get(it.key);
      cur.count += 1;
      cur.topSum += it.top;
      cur.bottomSum += it.bottom;
      cur.totalSum += itemTotal;
    }

    // แปลงเป็น array เรียงตาม key
    const rows = Array.from(map.entries())
      .map(([key, v]) => ({ key, count: v.count, topSum: v.topSum, bottomSum: v.bottomSum, totalSum: v.totalSum }))
      .sort((a, b) => a.key.localeCompare(b.key));

    return { rows, grand: grandTotal, grandTop: grandTopSum, grandBottom: grandBottomSum };
  }

  function money(n) {
    // แสดงรูปแบบเงิน
    return n.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  }

  window.deleteItem = function(index) {
    const item = items[index];
    const confirmMsg = `ต้องการลบรายการนี้?\n\n` +
      `งวด: ${item.draw}\n` +
      `หมายเลข: ${item.key}\n` +
      `บน: ${money(item.top)} บาท\n` +
      `ล่าง: ${money(item.bottom)} บาท\n` +
      `รวม: ${money(item.top + item.bottom)} บาท`;

    if (confirm(confirmMsg)) {
      items.splice(index, 1);
      saveToStorage();
      render();
    }
  }

  window.toggleShowAll = function() {
    showAllItems = !showAllItems;
    render();
  }

  window.toggleShowAllTable = function() {
    showAllTableRows = !showAllTableRows;
    render();
  }

  // ฟังก์ชันสำหรับหาตัวเลขคู่
  function getPairNumber(key) {
    return key.split('').reverse().join('');
  }

  // ตรวจสอบว่าเป็นเลขซ้ำหรือไม่ (11, 22, 33, ...)
  function isDoubleNumber(key) {
    return key[0] === key[1];
  }

  window.togglePairMode = function(heatmapType) {
    pairModeActive[heatmapType] = !pairModeActive[heatmapType];

    const btnId = heatmapType === 'prize' ? 'pairModeBtnPrize' : 'pairModeBtn';
    const btn = document.getElementById(btnId);

    if (pairModeActive[heatmapType]) {
      btn.classList.add('active');
      btn.textContent = 'เรียงแบบปกติ';
    } else {
      btn.classList.remove('active');
      btn.textContent = 'เรียงแบบคู่';
    }

    // Re-render heat map with new order
    render();
  }

  // ฟังก์ชันสำหรับสร้างลำดับการแสดงผล
  function getDisplayOrder(pairMode) {
    if (!pairMode) {
      // ลำดับปกติ: 00, 01, 02, ..., 98, 99
      return Array.from({ length: 100 }, (_, i) => String(i).padStart(2, '0'));
    } else {
      // ลำดับแบบคู่: 00, 01, 10, 02, 20, 03, 30, ..., 11, 22, 33, ..., 99
      const order = [];
      const added = new Set();

      // เพิ่มคู่ตัวเลขก่อน (ยกเว้นเลขซ้ำ)
      for (let i = 0; i < 100; i++) {
        const key = String(i).padStart(2, '0');
        if (!added.has(key) && !isDoubleNumber(key)) {
          order.push(key);
          added.add(key);

          const pair = getPairNumber(key);
          if (!added.has(pair)) {
            order.push(pair);
            added.add(pair);
          }
        }
      }

      // เพิ่มเลขซ้ำท้ายสุด
      for (let i = 0; i < 10; i++) {
        const key = String(i) + String(i);
        if (!added.has(key)) {
          order.push(key);
          added.add(key);
        }
      }

      return order;
    }
  }

  function getHeatmapColor(value, maxValue, colorScheme = 'blue') {
    if (value === 0) return '#f3f4f6';

    if (colorScheme === 'yellow') {
      // สีเหลือง-ส้มสำหรับ "บน"
      const ratio = value / maxValue;
      if (ratio < 0.2) return '#fef3c7';
      if (ratio < 0.4) return '#fde68a';
      if (ratio < 0.6) return '#fbbf24';
      if (ratio < 0.8) return '#f59e0b';
      return '#b45309';
    } else if (colorScheme === 'green') {
      // สีเขียวสำหรับ "ล่าง"
      const ratio = value / maxValue;
      if (ratio < 0.2) return '#dcfce7';
      if (ratio < 0.4) return '#86efac';
      if (ratio < 0.6) return '#4ade80';
      if (ratio < 0.8) return '#22c55e';
      return '#15803d';
    } else if (colorScheme === 'red') {
      // สีชมพู-แดงสำหรับเงินรางวัล - 7 ระดับตามยอดรวม (ความแตกต่างชัดเจน)
      if (value <= 10000) return '#f3f4f6';      // >0-5,000 (สีเทาอ่อน)
      if (value <= 20000) return '#fecaca';      // >5,000-10,000 (ชมพูอ่อน)
      if (value <= 40000) return '#fca5a5';      // >10,000-20,000 (ชมพู)
      if (value <= 80000) return '#f87171';      // >20,000-40,000 (แดงชมพู)
      if (value <= 200000) return '#ef4444';     // >40,000-100,000 (แดงเข้ม)
      return '#b91c1c';                          // >100,000 (แดงเข้มสุด)
    } else {
      // สีเขียว-น้ำเงินสำหรับรวม (โทนเย็น)
      const ratio = value / maxValue;
      if (ratio < 0.2) return '#d1fae5';         // น้อย (เขียวอ่อนมาก)
      if (ratio < 0.4) return '#6ee7b7';         // ปานกลาง (เขียวอ่อน)
      if (ratio < 0.6) return '#34d399';         // ปานกลาง-มาก (เขียวกลาง)
      if (ratio < 0.8) return '#10b981';         // มาก (เขียวเข้ม)
      return '#059669';                          // มากที่สุด (เขียวเข้มสุด)
    }
  }

  function getTextColor(bgColor) {
    // สีพื้นหลังเข้มจะใช้ตัวอักษรสีขาว
    const darkColors = ['#3b82f6', '#1e40af', '#b45309', '#15803d', '#22c55e', '#a855f7', '#9333ea', '#6b21a8', '#c084fc', '#7c3aed',
                        '#ec4899', '#db2777', '#be185d', '#10b981', '#059669',
                        '#f43f5e', '#e11d48', '#be123c', '#f87171', '#ef4444', '#dc2626', '#b91c1c'];
    return darkColors.includes(bgColor) ? '#ffffff' : '#111827';
  }

  function getBorderColor(bgColor, colorScheme, value = 0) {
    // สำหรับ Heat Map เงินรางวัล (ชมพู-แดง) ให้เส้นขอบเข้มกว่าพื้นหลัง
    if (colorScheme === 'red') {
      const borderMap = {
        '#f3f4f6': '#d1d5db',  // 0
        '#fecaca': '#fca5a5',  // >5K-10K
        '#fca5a5': '#f87171',  // >10K-20K
        '#f87171': '#ef4444',  // >20K-40K
        '#ef4444': '#dc2626',  // >40K-100K
        '#b91c1c': '#991b1b'   // >100K
      };
      // ถ้าสีพื้นหลังเป็น #f3f4f6 แต่มีค่ามากกว่า 0 ให้ใช้เส้นขอบเข้มกว่า
      if (bgColor === '#f3f4f6' && value > 0) {
        return '#9ca3af';  // เส้นขอบเทาเข้มกว่าสำหรับ >0-5K
      }
      return borderMap[bgColor] || '#d1d5db';
    } else if (colorScheme === 'blue') {
      // สำหรับ Heat Map ยอดรวม (เขียว) ให้เส้นขอบเข้มกว่าพื้นหลัง
      const borderMap = {
        '#f3f4f6': '#d1d5db',  // 0
        '#d1fae5': '#a7f3d0',  // น้อย
        '#6ee7b7': '#34d399',  // ปานกลาง
        '#34d399': '#10b981',  // ปานกลาง-มาก
        '#10b981': '#059669',  // มาก
        '#059669': '#047857'   // มากที่สุด
      };
      return borderMap[bgColor] || '#d1d5db';
    }
    // สำหรับ Heat Map อื่นๆ
    return '#d1d5db';
  }

  function renderHeatmapGeneric(gridId, valueType = 'total', colorScheme = 'blue', pairMode = false) {
    const heatmapGrid = document.getElementById(gridId);
    const { rows } = summarize();

    // สร้าง map ของยอดรวมแต่ละเลข
    const valueMap = new Map();
    const topMap = new Map();
    const bottomMap = new Map();

    rows.forEach(r => {
      topMap.set(r.key, r.topSum);
      bottomMap.set(r.key, r.bottomSum);

      if (valueType === 'top') {
        valueMap.set(r.key, r.topSum);
      } else if (valueType === 'bottom') {
        valueMap.set(r.key, r.bottomSum);
      } else if (valueType === 'split') {
        // สำหรับแสดงทั้งบนและล่าง ใช้ยอดรวมในการคำนวณสี
        valueMap.set(r.key, r.totalSum);
      } else if (valueType === 'prize') {
        // สำหรับแสดงเงินรางวัล ใช้ยอดรวมเงินรางวัล (บน + ล่าง) * 70
        valueMap.set(r.key, (r.topSum + r.bottomSum) * 70);
      } else {
        valueMap.set(r.key, r.totalSum);
      }
    });

    // หาค่าสูงสุด
    const maxValue = Math.max(...Array.from(valueMap.values()), 1);

    // สร้างเซลล์ตามลำดับที่กำหนด
    const displayOrder = getDisplayOrder(pairMode);
    heatmapGrid.innerHTML = '';
    for (const key of displayOrder) {
      const value = valueMap.get(key) || 0;
      const topValue = topMap.get(key) || 0;
      const bottomValue = bottomMap.get(key) || 0;
      const bgColor = getHeatmapColor(value, maxValue, colorScheme);
      const textColor = getTextColor(bgColor);
      const borderColor = getBorderColor(bgColor, colorScheme, value);

      const cell = document.createElement('div');
      cell.className = 'heatmap-cell';
      cell.style.backgroundColor = bgColor;
      cell.style.color = textColor;
      cell.style.borderColor = borderColor;
      cell.style.borderWidth = '3px';
      cell.dataset.key = key;

      // สร้างโครงสร้าง HTML ภายในเซลล์
      if (valueType === 'split') {
        // แสดงบนและล่างแยกกัน
        cell.innerHTML = `
          <div class="heatmap-cell-value">${topValue > 0 ? '<span class="heatmap-cell-label">บน</span> ' + money(topValue) : ''}</div>
          <div class="heatmap-cell-number">${key}</div>
          <div class="heatmap-cell-value">${bottomValue > 0 ? '<span class="heatmap-cell-label">ล่าง</span> ' + money(bottomValue) : ''}</div>
        `;
        cell.title = `${key}: บน ${money(topValue)}, ล่าง ${money(bottomValue)} บาท`;
      } else if (valueType === 'prize') {
        // แสดงเงินรางวัลบนและล่างแยกกัน
        const prizeTop = topValue * 70;
        const prizeBottom = bottomValue * 70;
        cell.innerHTML = `
          <div class="heatmap-cell-value">${prizeTop > 0 ? '<span class="heatmap-cell-label">บน</span> ' + money(prizeTop) : ''}</div>
          <div class="heatmap-cell-number">${key}</div>
          <div class="heatmap-cell-value">${prizeBottom > 0 ? '<span class="heatmap-cell-label">ล่าง</span> ' + money(prizeBottom) : ''}</div>
        `;
        cell.title = `${key}: เงินรางวัล(บน) ${money(prizeTop)}, เงินรางวัล(ล่าง) ${money(prizeBottom)} บาท`;
      } else {
        cell.innerHTML = `
          <div class="heatmap-cell-number">${key}</div>
          <div class="heatmap-cell-value">${value > 0 ? money(value) : ''}</div>
        `;

        if (valueType === 'top') {
          cell.title = `${key}: บน ${money(value)} บาท`;
        } else if (valueType === 'bottom') {
          cell.title = `${key}: ล่าง ${money(value)} บาท`;
        } else {
          cell.title = `${key}: รวม ${money(value)} บาท`;
        }
      }

      // เพิ่ม hover effect เพื่อแสดงคู่ตัวเลข
      const showHighlight = () => {
        if (isDoubleNumber(key)) {
          // เลขซ้ำใช้สีเขียว
          cell.classList.add('highlight-double');
        } else {
          // เลขคู่ใช้สีทอง
          const pairKey = getPairNumber(key);
          const pairCell = heatmapGrid.querySelector(`[data-key="${pairKey}"]`);
          if (pairCell) {
            cell.classList.add('highlight-pair');
            pairCell.classList.add('highlight-pair');
          }
        }
      };

      const hideHighlight = () => {
        if (isDoubleNumber(key)) {
          cell.classList.remove('highlight-double');
        } else {
          const pairKey = getPairNumber(key);
          const pairCell = heatmapGrid.querySelector(`[data-key="${pairKey}"]`);
          if (pairCell) {
            cell.classList.remove('highlight-pair');
            pairCell.classList.remove('highlight-pair');
          }
        }
      };

      const toggleHighlight = () => {
        if (isDoubleNumber(key)) {
          cell.classList.toggle('highlight-double');
        } else {
          const pairKey = getPairNumber(key);
          const pairCell = heatmapGrid.querySelector(`[data-key="${pairKey}"]`);
          if (pairCell) {
            cell.classList.toggle('highlight-pair');
            pairCell.classList.toggle('highlight-pair');
          }
        }
      };

      // Mouse events for desktop
      cell.addEventListener('mouseenter', showHighlight);
      cell.addEventListener('mouseleave', hideHighlight);

      // Touch events for mobile/tablet - toggle on/off
      cell.addEventListener('touchstart', (e) => {
        e.preventDefault();
        toggleHighlight();
      });

      heatmapGrid.appendChild(cell);
    }
  }

  function renderHeatmap() {
    renderHeatmapGeneric('heatmapGrid', 'split', 'blue', pairModeActive.total);
  }

  function renderHeatmapPrize() {
    renderHeatmapGeneric('heatmapGridPrize', 'prize', 'red', pairModeActive.prize);
  }

  function shortenDraw(draw) {
    // แปลง "มกราคม 2568 งวด 1" เป็น "ม.ค. 68 งวด 1"
    const monthMap = {
      'มกราคม': 'ม.ค.', 'กุมภาพันธ์': 'ก.พ.', 'มีนาคม': 'มี.ค.',
      'เมษายน': 'เม.ย.', 'พฤษภาคม': 'พ.ค.', 'มิถุนายน': 'มิ.ย.',
      'กรกฎาคม': 'ก.ค.', 'สิงหาคม': 'ส.ค.', 'กันยายน': 'ก.ย.',
      'ตุลาคม': 'ต.ค.', 'พฤศจิกายน': 'พ.ย.', 'ธันวาคม': 'ธ.ค.'
    };

    let result = draw;
    for (const [full, short] of Object.entries(monthMap)) {
      result = result.replace(full, short);
    }
    // แปลงปี 2568 เป็น 68
    result = result.replace(/\s(\d{2})(\d{2})\s/g, ' $2 ');
    return result;
  }

  function render() {
    // Raw list
    if (items.length === 0) {
      rawList.textContent = 'ยังไม่มีรายการ';
    } else {
      const reversedItems = items.slice().reverse();
      const displayItems = showAllItems ? reversedItems : reversedItems.slice(0, 5);

      const itemsHtml = displayItems
        .map((it, revIdx) => {
          const idx = items.length - 1 - revIdx;
          const isLatest = revIdx === 0;
          const itemClass = isLatest ? 'raw-item raw-item-latest' : 'raw-item';
          const shortDraw = shortenDraw(it.draw);
          return `
            <div class="${itemClass}">
              <button class="delete-btn" onclick="deleteItem(${idx})">ลบ</button><span><b>${idx + 1}.</b> [${shortDraw}] ${it.key} → บน: ${money(it.top)}, ล่าง: ${money(it.bottom)}</span>
            </div>
          `;
        })
        .join('');

      const showAllButton = items.length > 5 && !showAllItems
        ? `<button class="show-all-btn" onclick="toggleShowAll()">ดูทั้งหมด (${items.length} รายการ)</button>`
        : items.length > 5 && showAllItems
        ? `<button class="show-all-btn" onclick="toggleShowAll()">ย่อรายการ</button>`
        : '';

      rawList.innerHTML = itemsHtml + showAllButton;
    }

    // Summary
    const { rows, grand, grandTop, grandBottom } = summarize();
    const displayRows = showAllTableRows ? rows : rows.slice(0, 5);

    summaryBody.innerHTML = displayRows.map(r => `
      <tr>
        <td>${r.key}</td>
        <td>${r.count}</td>
        <td>${money(r.topSum)}<br><small style="color: #6b7280;">รางวัล: ${money(r.topSum * 70)}</small></td>
        <td>${money(r.bottomSum)}<br><small style="color: #6b7280;">รางวัล: ${money(r.bottomSum * 70)}</small></td>
        <td>${money(r.totalSum)}</td>
      </tr>
    `).join('');

    // เพิ่มปุ่มแสดง/ซ่อนแถวตาราง
    if (rows.length > 5) {
      const toggleButton = showAllTableRows
        ? `<tr><td colspan="5" style="text-align: center; padding: 8px;"><button class="show-all-btn" onclick="toggleShowAllTable()">ย่อตาราง</button></td></tr>`
        : `<tr><td colspan="5" style="text-align: center; padding: 8px;"><button class="show-all-btn" onclick="toggleShowAllTable()">ดูทั้งหมด (${rows.length} ตัวเลข)</button></td></tr>`;
      summaryBody.innerHTML += toggleButton;
    }

    // อัพเดทยอดรวมใน footer - แสดงเฉพาะยอดรวม ไม่แสดงเงินรางวัล
    totalCountEl.textContent = items.length;
    grandPrizeTopEl.textContent = money(grandTop);
    grandPrizeBottomEl.textContent = money(grandBottom);
    grandTotalEl.textContent = money(grand);

    // Render heatmaps
    renderHeatmap();
    renderHeatmapPrize();
  }

  // Validate drawNumberInput to allow only 1 or 2
  drawNumberInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^12]/g, '');
  });

  // Validate yearInput to allow only 4 digits
  yearInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 4);
  });

  // Validate keyInput to allow only 2 digits
  keyInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 2);
  });

  // ฟังก์ชันเพิ่มจำนวนเงินในช่อง input
  window.addToInput = function(inputId, amount) {
    const input = document.getElementById(inputId);
    const currentValue = parseAmount(input.value) || 0;
    input.value = currentValue + amount;
  }

  // ฟังก์ชันเพิ่มจำนวนเงินทั้งบนและล่าง
  window.addToBothInputs = function(amount) {
    const topCurrentValue = parseAmount(topInput.value) || 0;
    const bottomCurrentValue = parseAmount(bottomInput.value) || 0;
    topInput.value = topCurrentValue + amount;
    bottomInput.value = bottomCurrentValue + amount;
  }

  addBtn.addEventListener('click', () => {
    addItem(drawNumberInput.value, monthSelect.value, yearInput.value, keyInput.value, topInput.value, bottomInput.value);
    keyInput.value = '';
    topInput.value = '';
    bottomInput.value = '';
    keyInput.focus();
  });

  clearBtn.addEventListener('click', () => {
    if (items.length === 0) return;
    if (confirm('คุณต้องการล้างข้อมูลทั้งหมดใช่หรือไม่?')) {
      items.length = 0;
      saveToStorage();
      render();
    }
  });

  exportBtn.addEventListener('click', async () => {
    const { rows, grand, grandTop, grandBottom } = summarize();

    // รวบรวมงวดทั้งหมดที่มีในข้อมูล
    const draws = [...new Set(items.map(it => it.draw))].sort();
    const drawsText = draws.length > 0 ? `งวด: ${draws.join(', ')}\n` : '';

    const text = [
      'สรุปรวมเงินตามตัวเลข',
      drawsText,
      ...rows.map(r => `เลข: ${r.key} / จำนวนรายการ: ${r.count} / บน: ${money(r.topSum)} / ล่าง: ${money(r.bottomSum)} / รวม: ${money(r.totalSum)}`),
      '',
      `รวมทั้งหมด / จำนวนรายการทั้งหมด: ${items.length} / บน: ${money(grandTop)} / ล่าง: ${money(grandBottom)} / รวม: ${money(grand)}`
    ].join('\n');

    try {
      await navigator.clipboard.writeText(text);
      alert('คัดลอกสรุปแล้ว');
    } catch {
      // fallback
      prompt('คัดลอกเองจากช่องนี้:', text);
    }
  });

  initMonthOptions();
  loadLastDraw();
  render();
</script>
</body>
</html>
